name: Release Charts

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install chart-releaser
        run: |
          CR_VERSION="1.6.1"
          curl -sSLo cr.tar.gz "https://github.com/helm/chart-releaser/releases/download/v${CR_VERSION}/chart-releaser_${CR_VERSION}_linux_amd64.tar.gz"
          tar -xzf cr.tar.gz cr
          mv cr /usr/local/bin/cr

      # chart-releaser-action only discovers immediate children of charts_dir.
      # Our charts live in nested directories (app/, apps/openclaw/, gateways/*/),
      # so we find, package, and release them manually.
      - name: Package and release charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          charts=$(find . -name Chart.yaml -not -path './.git/*' -exec dirname {} \; | sort)
          echo "Found charts:"
          echo "$charts"

          mkdir -p .cr-release-packages

          for chart in $charts; do
            name=$(helm show chart "$chart" | grep '^name:' | awk '{print $2}')
            version=$(helm show chart "$chart" | grep '^version:' | awk '{print $2}')
            tag="${name}-${version}"

            # Skip if release already exists
            if gh release view "$tag" &>/dev/null; then
              echo "Skipping $tag (already released)"
              continue
            fi

            echo "Packaging $chart â†’ $tag"
            helm package "$chart" -d .cr-release-packages
          done

          # Upload new packages as GitHub releases
          for pkg in .cr-release-packages/*.tgz; do
            [ -f "$pkg" ] || { echo "No new charts to release"; exit 0; }
            tag=$(basename "$pkg" .tgz)
            echo "Creating release $tag"
            gh release create "$tag" "$pkg" --title "$tag" --generate-notes
          done

      - name: Update Helm repo index
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          owner="${GITHUB_REPOSITORY_OWNER}"
          repo="${GITHUB_REPOSITORY#*/}"

          # Merge new releases into existing index.yaml on gh-pages
          cr index \
            --owner "$owner" \
            --git-repo "$repo" \
            --pages-branch gh-pages \
            --push \
            --release-name-template '{{ .Name }}-{{ .Version }}'

      - name: Sync artifacthub-repo.yml to gh-pages
        run: |
          git fetch origin gh-pages
          git checkout gh-pages
          git checkout main -- artifacthub-repo.yml
          git add artifacthub-repo.yml
          if git diff --cached --quiet; then
            echo "artifacthub-repo.yml unchanged"
          else
            git commit -m "chore: sync artifacthub-repo.yml from main"
            git push origin gh-pages
          fi
