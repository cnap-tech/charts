# HTTPRoute Chart

Creates an HTTPRoute resource for Kubernetes Gateway API.

## Prerequisites

- Kubernetes 1.24+
- Gateway API CRDs installed (`kubectl apply -k github.com/kubernetes-sigs/gateway-api//config/crd?ref=v1.0.0`)
- A Gateway resource already deployed in the cluster

## Usage

```bash
helm install my-route . \
  --set parentRef.name=my-gateway \
  --set parentRef.namespace=gateway-system \
  --set hostnames[0]=myapp.example.com \
  --set backendRef.name=my-service \
  --set backendRef.port=8080
```

Or with a values file:

```yaml
# values.yaml
parentRef:
  name: my-gateway
  namespace: gateway-system

hostnames:
  - myapp.example.com
  - api.example.com

backendRef:
  name: my-service
  port: 8080

rules:
  - matches:
      - path:
          type: PathPrefix
          value: /api
  - matches:
      - path:
          type: PathPrefix
          value: /
```

## Values

| Key | Type | Default | Description |
|-----|------|---------|-------------|
| `parentRef.name` | string | `""` | **Required.** Name of the Gateway to attach to |
| `parentRef.namespace` | string | `""` | **Required.** Namespace of the Gateway |
| `parentRef.sectionName` | string | `""` | Optional specific listener name on the Gateway |
| `hostnames` | list | `[]` | Hostnames to match (e.g., `["myapp.example.com"]`) |
| `backendRef.name` | string | `""` | **Required.** Name of the backend Service |
| `backendRef.namespace` | string | `""` | Namespace of the backend Service (defaults to release namespace) |
| `backendRef.port` | int | `80` | Port on the backend Service |
| `backendRef.weight` | int | `1` | Weight for traffic splitting |
| `additionalBackendRefs` | list | `[]` | Additional backends for traffic splitting |
| `rules` | list | `[{matches: [{path: {type: PathPrefix, value: /}}]}]` | Routing rules with path/header/query matching |
| `filters` | list | `[]` | Request/response filters |
| `labels` | object | `{}` | Additional labels for the HTTPRoute |
| `annotations` | object | `{}` | Additional annotations for the HTTPRoute |

## Examples

### Basic Route

```yaml
parentRef:
  name: nginx-gateway
  namespace: nginx-system

hostnames:
  - myapp.example.com

backendRef:
  name: my-app
  port: 8080
```

### Path-Based Routing

```yaml
parentRef:
  name: nginx-gateway
  namespace: nginx-system

hostnames:
  - api.example.com

backendRef:
  name: api-service
  port: 8080

rules:
  - matches:
      - path:
          type: PathPrefix
          value: /v1
  - matches:
      - path:
          type: PathPrefix
          value: /v2
```

### Canary Deployment (Traffic Splitting)

```yaml
parentRef:
  name: nginx-gateway
  namespace: nginx-system

hostnames:
  - myapp.example.com

backendRef:
  name: my-app-stable
  port: 8080
  weight: 90

additionalBackendRefs:
  - name: my-app-canary
    port: 8080
    weight: 10
```

### Header-Based Routing

```yaml
parentRef:
  name: nginx-gateway
  namespace: nginx-system

hostnames:
  - api.example.com

backendRef:
  name: api-v2
  port: 8080

rules:
  - matches:
      - path:
          type: PathPrefix
          value: /
        headers:
          - name: x-api-version
            value: v2
```

## Integration with CNAP

When deploying apps through CNAP with "Expose externally" enabled, this chart is automatically added as an ArgoCD source with computed values:

```yaml
# Auto-generated by CNAP
parentRef:
  name: <selected-gateway>
  namespace: <gateway-namespace>

hostnames:
  - <generated-or-custom-hostname>

backendRef:
  name: <app-service-name>
  port: <configured-port>
```

